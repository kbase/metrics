#!/usr/local/bin/python

import os
import mysql.connector as mysql

metrics_mysql_password = os.environ["METRICS_MYSQL_PWD"]
sql_host = os.environ["SQL_HOST"]
metrics = os.environ["QUERY_ON"]


def dump_query_results():
    """
    It is a simple SQL table dump of a given query so we can supply users with custom tables.
    Note that the SQL query itself and column headers portion need to be changed if you want to change
    the query/results. Otherwise it is good to go.
    It can be called simply with the bin shell script.
    Read the README at the top level for an example.
    docker-compose run --rm metrics ../bin/custom_scripts/dump_query_results.sh > query_results.txt

    """
    # connect to mysql
    db_connection = mysql.connect(
        host=sql_host,  # "mysql1", #"localhost",
        user="metrics",  # "root",
        passwd=metrics_mysql_password,
        database="metrics",  # "datacamp"
    )

    cursor = db_connection.cursor()
    query = "use " + metrics
    cursor.execute(query)

    # CHANGE QUERY HERE
    #    query = "select username, display_name, email, orcid, kb_internal_user, institution, country, signup_date, last_signin_date from user_info order by signup_date"
    #    query = "select username, display_name, email from metrics.user_info where username in "\
    # "('aaronjberliner',    'ab',    'abrumbaugh',    'adevoto',    'adilavy',    'adrouin',    'aebeck',    'agmcfarland',    'agnespychan',    'ahgiridh',    'aktest',    'alexbene',    'allenbh',    'allmon',    'almut_heinken',    'amasberry',    'amcastinado',    'amco',    'amorozov',    'ana_alao',    'anarita1984',    'anavid',    'andreiapmagalhaes',    'andrew78',    'anileipaz',    'anitavoigt',    'ankurnaqib',    'anna_zelaya',    'anocaj',    'anthonykappell',    'aparkin',    'arandich',    'arwyer',    'arz107',    'asgandhi',    'astridterry',    'astrosmith',    'asuccurro',    'asweiss',    'avigoyal2',    'avirshup',    'ayan2015',    'ayee',    'azimbe',    'aziz1358',    'azk172',    'badler',    'bgranger',    'bhurwitz',    'bishoyh',    'bkcox123',    'bking',    'blavergar',    'bobcottingham',    'boeuf',    'boisvert',    'bpark',    'bpb',    'bpenalver',    'bri_mc_d',    'broadbelt',    'brooke_weigel',    'brownj',    'brysonsam',    'bsadkhin',    'bzabel32',    'cacontad',    'calvincicha',    'campbelle',    'caozhichong',    'carlamag',    'carobi',    'caschu22',    'caseyhooker59',    'catherineanders',    'cbmccorison',    'cedwardson',    'ceri_proffitt',    'cerikson',    'cesarcardonau',    'cfrioux',    'chandrika',    'chenry',    'chenx',    'chienchilo',    'christianlieven',    'claireboulange',    'claudiaamorim',    'cmarshall',    'cmhudso',    'cnelson',    'coldfire',    'connorskennerton',    'cretoiums',    'cschlundt',    'ctcquigley',    'cthinnes',    'ctimm',    'cvenero1',    'cwickware',    'cyz',    'dacb',    'dang',    'dangunter',    'danielberrios',    'dbernstein',    'dboeufglobus',    'deboraferreira',    'dejongh',    'denrew88',    'dinesh2k19',    'dipalisingh',    'djinnome',    'dmoulton',    'dolson',    'dougvj',    'dp',    'drakemm2',    'drbandoy',    'dsihi',    'dylan',    'eakiva',    'eapearson',    'eason2',    'ebbole',    'ecls',    'eddyb2',    'eeshelkr',    'ejmiller5',    'elkebrockmann',    'elsemman',    'eperedo',    'epicadvait',    'esryu',    'etaylo58',    'evaso',    'evasquez',    'ewmorrison',    'falknagies',    'feina405',    'ferrellb',    'filipeliu',    'flynnp91',    'foxjones',    'fperez',    'frodriguez',    'galileo92',    'gaohanlisa',    'gaprice',    'gd',    'gfaraci',    'gfwells',    'gkrantz',    'green267',    'h2o',    'haaxr',    'handsomejjs',    'haneef',    'heejoon',    'hgmorrison',    'hgoemann',    'hhohbein',    'hjsmith12',    'hlh35',    'honghuahu',    'hotlakes',    'hsalamon',    'huaner',    'huseyin',    'huxxx535',    'hwangchi740',    'hyunsong',    'iarkhipova',    'ines_thiele',    'ines1i',    'inesthiele123',    'injamartin',    'iquasere',    'irami007',    'isaac',    'itsamit79',    'ivanoresnik',    'iyn',    'iyushenova',    'jacobshoemake',    'jagariko',    'jakeqiu',    'jamestmetz',    'janaka',    'janakakbase',    'jayrbolton',    'jcatlett',    'jdood',    'jennyn',    'jeremymchacon',    'jerickson',    'jewim',    'jfessler',    'jfroula',    'jgabriel1206',    'jill777r',    'jjeffryes',    'jkbaumohl',    'jkiefer',    'jmarkwelch',    'jmc',    'jmcnick',    'jmyers522',    'jnwoodhouse',    'joana_rodrigues',    'joana1989',    'john',    'john2185',    'johnsanterre',    'joshamilton',    'jpadrao',    'jplfaria',    'jtclaypool',    'jtl468',    'juancamilovillada',    'judemaul4848',    'juliabr',    'julietrinh',    'jvds',    'jwoodhouse',    'jyothi',    'k2bhide',    'kallotenue',    'katjh',    'kbase_daisy',    'kbasedata',    'kbasedev',    'kbasedocumentation',    'kbasehelp',    'kbasetest',    'kbdeleon',    'kbeilsmith',    'kdittmann',    'kenn',    'kkeller',    'kkganko',    'kothariankita',    'kpjcherish2018',    'kpn4',    'kpujara',    'ksipes',    'ktruelson',    'ktyo',    'kymo',    'landml',    'laramyenders',    'lauren_blake',    'laurenlui',    'laurenpetersen',    'lbjones',    'leobaumgart',    'lhuang',    'ligiaftsouza',    'limenitakis',    'liu2040',    'lmseyler84',    'lnanderson',    'longyun',    'loretta',    'louellette',    'luisdrmelo',    'luj',    'm7xu',    'madonglin',    'manish16',    'manusthoen',    'marcin',    'marconv',    'margaux974',    'markborkum',    'markusdieser',    'martinh',    'marvas',    'mattdotvaughn',    'mazhar303',    'mberacochea',    'mc_escherichia',    'mcbtsilimigras',    'mccorkle',    'mcflynn617',    'megangrimes',    'meo',    'meren',    'mhenderson',    'mhgarci1',    'michael_shaffer',    'miche',    'miguelrocha',    'mikaelacashman',    'mikehamiltoncollege',    'mikethomas',    'miriamcode',    'miriamtester',    'mjhill',    'mm_clark',    'mmreich81',    'mohit',    'morbeb',    'morgannprice',    'mpaxhia',    'msaif',    'mscarborough',    'mserres',    'msneddon',    'mspoto',    'msubiodiversity',    'mt_szn',    'mthommes',    'mtrobey',    'mwigre',    'myracohen',    'nconrad',    'nhess0618',    'nidhi112000',    'nil008',    'nkk_comp',    'nlharris',    'nps',    'nuhbtad',    'nyukinghing',    'oerbilgin',    'ohealy',    'okweon',    'olganovichkova',    'olson',    'omarcu',    'oscarleo1',    'ouellette',    'pac',    'pandeer2',    'pangenomics',    'paspi100',    'patrikd',    'pdiazmoreno',    'phantomas1234',    'platyias',    'pmouser',    'pnovichov',    'poonamp',    'pranjan77',    'psd_admin',    'psdehal',    'psnovichkov',    'pwen',    'qzhang',    'rafaelalves',    'ragavishan',    'rahuja',    'rap17d',    'rebcalle',    'resonating',    'rhizoman',    'rivers',    'riyuebao',    'rlbier',    'rlrubinstein',    'rluthringer',    'rmr',    'robegbert',    'robingerlach',    'rodrigo2017',    'rodriguezramos',    'romain_darnajoux',    'rombm',    'rosscarlson2',    'royk',    'rpeters',    'rprops2',    'rsatterwhite',    'rsfive',    'rsutormin',    'ruijiehan1116',    'ruthperezgallego',    'rwilhelm',    'sagoyal',    'saltenburg',    'salvador_a',    'sanjoy',    'sarah',    'sarahnadeau',    'sbelanov',    'scanon',    'scanonadmin',    'scarim',    'seanjungbluth',    'seaver',    'seb369',    'secalhoun',    'shabana',    'shl169',    'shushengwang',    'silviosantos',    'skinnyorange',    'slebras',    'slillington',    'smagnusd',    'smars0001',    'smsievert',    'sngaddam',    'soohyun',    'srividya22',    'ssiaws',    'sstevens',    'staylor',    'stegen',    'steve_brown',    'stienda',    'sturkarslan',    'sturne29',    'sudarshan',    'sulbha02',    'sunita',    'sunxiaoli2008',    'swatim',    'sychan',    'tabi',    'tgu',    'tgu2',    'thorsten',    'tjgriffi',    'tls',    'trrg',    'ts501',    'tscheibe',    'tvishniv',    'ubbi',    'uchaitao',    'upamakc7',    'usmanova_dina',    'vaglius',    'valter',    'vcrecy',    'veytiah',    'vincentdunon',    'vkrumins',    'vkumar',    'vpylro',    'wcnelson',    'weise',    'wenyingshou',    'wgeorgescu',    'wilke',    'wjriehl',    'wonght12',    'xg_grace',    'xianghui',    'xiaojun011',    'xiaoqinwu2',    'xie186',    'xp_hu',    'xuehangsong',    'xueyingzhao1127',    'ycchang',    'ychoi',    'yyun',    'z7cheng',    'zahmeeth',    'zanderh22',    'zcrockett',    'zhalnina',    'zhangtianyu') order by username;"

    #    query = "select ui.username, ui.email, ui.last_signin_date, max(si.last_seen), "\
    #            "CASE WHEN ui.last_signin_date > '2019-10-08'  or max(si.last_seen) > '2019-10-08' THEN 'Been seen' ELSE 'NOT SEEN' END AS HasBeenSeen "\
    #            "from user_info ui left outer join session_info si on ui.username = si.username "\
    #            "where ui.username in ( 'aaronjberliner', 'ab', 'abrumbaugh', 'adevoto', 'adilavy', 'adrouin', 'aebeck', 'agmcfarland', 'agnespychan', 'ahgiridh', 'aktest', 'alexbene', 'allenbh', 'allmon', 'almut_heinken', 'amasberry', 'amcastinado', 'amco', 'amorozov', 'anarita1984', 'anavid', 'ana_alao', 'andreiapmagalhaes', 'andrew78', 'anileipaz', 'anitavoigt', 'ankurnaqib', 'anna_zelaya', 'anocaj', 'anthonykappell', 'aparkin', 'arandich', 'arwyer', 'arz107', 'asgandhi', 'astridterry', 'astrosmith', 'asuccurro', 'asweiss', 'avigoyal2', 'avirshup', 'ayan2015', 'ayee', 'azimbe', 'aziz1358', 'azk172', 'badler', 'bgranger', 'bhurwitz', 'bishoyh', 'bkcox123', 'bking', 'blavergar', 'bobcottingham', 'boeuf', 'boisvert', 'bpark', 'bpb', 'bpenalver', 'bri_mc_d', 'broadbelt', 'brooke_weigel', 'brownj', 'brysonsam', 'bsadkhin', 'bzabel32', 'cacontad', 'calvincicha', 'campbelle', 'caozhichong', 'carlamag', 'carobi', 'caschu22', 'caseyhooker59', 'catherineanders', 'cbmccorison', 'cedwardson', 'cerikson', 'ceri_proffitt', 'cesarcardonau', 'cfrioux', 'chandrika', 'chenry', 'chenx', 'chienchilo', 'christianlieven', 'claireboulange', 'claudiaamorim', 'cmarshall', 'cmhudso', 'cnelson', 'coldfire', 'connorskennerton', 'cretoiums', 'cschlundt', 'ctcquigley', 'cthinnes', 'ctimm', 'cvenero1', 'cwickware', 'cyz', 'dacb', 'dang', 'dangunter', 'danielberrios', 'dbernstein', 'dboeufglobus', 'deboraferreira', 'dejongh', 'denrew88', 'dinesh2k19', 'dipalisingh', 'djinnome', 'dmoulton', 'dolson', 'dougvj', 'dp', 'drakemm2', 'drbandoy', 'dsihi', 'dylan', 'eakiva', 'eapearson', 'eason2', 'ebbole', 'ecls', 'eddyb2', 'eeshelkr', 'ejmiller5', 'elkebrockmann', 'elsemman', 'eperedo', 'epicadvait', 'esryu', 'etaylo58', 'evaso', 'evasquez', 'ewmorrison', 'falknagies', 'feina405', 'ferrellb', 'filipeliu', 'flynnp91', 'foxjones', 'fperez', 'frodriguez', 'galileo92', 'gaohanlisa', 'gaprice', 'gd', 'gfaraci', 'gfwells', 'gkrantz', 'green267', 'h2o', 'haaxr', 'handsomejjs', 'haneef', 'heejoon', 'hgmorrison', 'hgoemann', 'hhohbein', 'hjsmith12', 'hlh35', 'honghuahu', 'hotlakes', 'hsalamon', 'huaner', 'huseyin', 'huxxx535', 'hwangchi740', 'hyunsong', 'iarkhipova', 'ines1i', 'inesthiele123', 'ines_thiele', 'injamartin', 'iquasere', 'irami007', 'isaac', 'itsamit79', 'ivanoresnik', 'iyn', 'iyushenova', 'jacobshoemake', 'jagariko', 'jakeqiu', 'jamestmetz', 'janaka', 'janakakbase', 'jayrbolton', 'jcatlett', 'jdood', 'jennyn', 'jeremymchacon', 'jerickson', 'jewim', 'jfessler', 'jfroula', 'jgabriel1206', 'jill777r', 'jjeffryes', 'jkbaumohl', 'jkiefer', 'jmarkwelch', 'jmc', 'jmcnick', 'jmyers522', 'jnwoodhouse', 'joana1989', 'joana_rodrigues', 'john', 'john2185', 'johnsanterre', 'joshamilton', 'jpadrao', 'jplfaria', 'jtclaypool', 'jtl468', 'juancamilovillada', 'judemaul4848', 'juliabr', 'julietrinh', 'jvds', 'jwoodhouse', 'jyothi', 'k2bhide', 'kallotenue', 'katjh', 'kbasedata', 'kbasedev', 'kbasedocumentation', 'kbasehelp', 'kbasetest', 'kbase_daisy', 'kbdeleon', 'kbeilsmith', 'kdittmann', 'kenn', 'kkeller', 'kkganko', 'kothariankita', 'kpjcherish2018', 'kpn4', 'kpujara', 'ksipes', 'ktruelson', 'ktyo', 'kymo', 'landml', 'laramyenders', 'laurenlui', 'laurenpetersen', 'lauren_blake', 'lbjones', 'leobaumgart', 'lhuang', 'ligiaftsouza', 'limenitakis', 'liu2040', 'lmseyler84', 'lnanderson', 'longyun', 'loretta', 'louellette', 'luisdrmelo', 'luj', 'm7xu', 'madonglin', 'manish16', 'manusthoen', 'marcin', 'marconv', 'margaux974', 'markborkum', 'markusdieser', 'martinh', 'marvas', 'mattdotvaughn', 'mazhar303', 'mberacochea', 'mcbtsilimigras', 'mccorkle', 'mcflynn617', 'mc_escherichia', 'megangrimes', 'meo', 'meren', 'mhenderson', 'mhgarci1', 'michael_shaffer', 'miche', 'miguelrocha', 'mikaelacashman', 'mikehamiltoncollege', 'mikethomas', 'miriamcode', 'miriamtester', 'mjhill', 'mmreich81', 'mm_clark', 'mohit', 'morbeb', 'morgannprice', 'mpaxhia', 'msaif', 'mscarborough', 'mserres', 'msneddon', 'mspoto', 'msubiodiversity', 'mthommes', 'mtrobey', 'mt_szn', 'mwigre', 'myracohen', 'nconrad', 'nhess0618', 'nidhi112000', 'nil008', 'nkk_comp', 'nlharris', 'nps', 'nuhbtad', 'nyukinghing', 'oerbilgin', 'ohealy', 'okweon', 'olganovichkova', 'olson', 'omarcu', 'oscarleo1', 'ouellette', 'pac', 'pandeer2', 'pangenomics', 'paspi100', 'patrikd', 'pdiazmoreno', 'phantomas1234', 'platyias', 'pmouser', 'pnovichov', 'poonamp', 'pranjan77', 'psdehal', 'psd_admin', 'psnovichkov', 'pwen', 'qzhang', 'rafaelalves', 'ragavishan', 'rahuja', 'rap17d', 'rebcalle', 'resonating', 'rhizoman', 'rivers', 'riyuebao', 'rlbier', 'rlrubinstein', 'rluthringer', 'rmr', 'robegbert', 'robingerlach', 'rodrigo2017', 'rodriguezramos', 'romain_darnajoux', 'rombm', 'rosscarlson2', 'royk', 'rpeters', 'rprops2', 'rsatterwhite', 'rsfive', 'rsutormin', 'ruijiehan1116', 'ruthperezgallego', 'rwilhelm', 'sagoyal', 'saltenburg', 'salvador_a', 'sanjoy', 'sarah', 'sarahnadeau', 'sbelanov', 'scanon', 'scanonadmin', 'scarim', 'seanjungbluth', 'seaver', 'seb369', 'secalhoun', 'shabana', 'shl169', 'shushengwang', 'silviosantos', 'skinnyorange', 'slebras', 'slillington', 'smagnusd', 'smars0001', 'smsievert', 'sngaddam', 'soohyun', 'srividya22', 'ssiaws', 'sstevens', 'staylor', 'stegen', 'steve_brown', 'stienda', 'sturkarslan', 'sturne29', 'sudarshan', 'sulbha02', 'sunita', 'sunxiaoli2008', 'swatim', 'sychan', 'tabi', 'tgu', 'tgu2', 'thorsten', 'tjgriffi', 'tls', 'trrg', 'ts501', 'tscheibe', 'tvishniv', 'ubbi', 'uchaitao', 'upamakc7', 'usmanova_dina', 'vaglius', 'valter', 'vcrecy', 'veytiah', 'vincentdunon', 'vkrumins', 'vkumar', 'vpylro', 'wcnelson', 'weise', 'wenyingshou', 'wgeorgescu', 'wilke', 'wjriehl', 'wonght12', 'xg_grace', 'xianghui', 'xiaojun011', 'xiaoqinwu2', 'xie186', 'xp_hu', 'xuehangsong', 'xueyingzhao1127', 'ycchang', 'ychoi', 'yyun', 'z7cheng', 'zahmeeth', 'zanderh22', 'zcrockett', 'zhalnina', 'zhangtianyu') "\
    # "group by ui.username, ui.email, ui.last_signin_date;"

    #    query = "select * from workspaces where narrative_version > 0 and is_temporary is null";
    query = (
        "select func_name, DATE_FORMAT(`finish_date`,'%Y-%m') as finish_month, count(*) as run_count, "
        "avg(run_time) as avg_run_time_secs, sum(run_time) as total_run_time_secs "
        "from metrics.user_app_usage where is_error = 0 group by func_name, finish_month;"
    )
    # CHANGE COLUMN HEADERS HERE TO MATCH QUERY HEADERS
    #    print("username\temail\tlast_signin_date\tmax_last_seen\tHasBeenSeen")
    #    print("ws_id\tusername\tmod_date\tinitial_save_date\trecord_date\ttop_lvl_object_count\ttotal_object_count\tvisible_app_cells_count\tnarrative_version\thidden_object_count\tdeleted_object_count\ttotal_size\ttop_lvl_size\tis_public\tis_temporary\tnumber_of_shares")
    print(
        "function_name\tfinish_month\tsuccessful_run_count\taverage_run_time\ttotal_run_time"
    )

    cursor.execute(query)
    row_values = list()

    for row_values in cursor:
        temp_string = ""
        for i in range(len(row_values) - 1):
            if row_values[i] is not None:
                temp_string += str(row_values[i])
            temp_string += "\t"
        if row_values[-1] is not None:
            temp_string += str(row_values[-1])
        print(temp_string)
    return 1


dump_query_results()
